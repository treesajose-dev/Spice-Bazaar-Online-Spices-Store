<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Subcategory Management</title>
        <link rel="stylesheet" href="/static/css/styles.css">
        <link rel="stylesheet" href="/static/css/form_style.css">
        <script src="{{ url_for('static', filename='js/resize_img.js') }}"></script>
    </head>
<body>
    
    <div class="admin-dashboard">
        {% if user_data and user_data['username'] == 'ossmanager123@gmail.com' %}
            <a href="/admindash">&larr; Admin Dashboard</a>
        {% else %}
            <a href="/staffdash">&larr; Staff Dashboard</a>
        {% endif %}
    </div>

    <div class="container">
        <h1><center>Subcategory Management</center></h1>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for subcategory, message in messages %}
                    <div class="{{ subcategory }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Add or Edit Subcategory Form -->
        <div class="form-container">
            {% if subcategory and subcategory.Subcat_id %}
                <h2>Edit Subcategory</h2>
                <form action="{{ url_for('edit_subcategory_route', subcat_id=subcategory.Subcat_id) }}" 
                      method="POST" 
                      enctype="multipart/form-data">
            {% else %}
                <h2>Add New Subcategory</h2>
                <form action="{{ url_for('add_subcategory_route') }}" 
                      method="POST" 
                      enctype="multipart/form-data">
            {% endif %}
                
            <div class="form-group">
                <label for="cat_id">Select Category:</label>
                <select id="cat_id" name="cat_id" required>
                    <option value="" disabled selected>Select a category</option>
                    {% for category in categories %}
                        <option value="{{ category.Cat_id }}" 
                            {% if subcategory and subcategory.Cat_id == category.Cat_id %}selected{% endif %}>
                            {{ category.Cat_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>    

                <div class="form-group">
                    <label for="subcat_name">Subcategory Name:</label>
                    <input type="text" 
                           id="subcat_name" 
                           name="subcat_name" 
                           value="{{ subcategory.Subcat_name if subcategory else '' }}" 
                           required>
                </div>
        
                <div class="form-group">
                    <label for="subcat_desc">Subcategory Description:</label>
                    <textarea id="subcat_desc" 
                            name="subcat_desc" 
                            required 
                            rows="3">{{ subcategory.Subcat_desc if subcategory else '' }}</textarea>
                </div>
        
                <div class="form-group">
                    <label for="subcat_image">Subcategory Image:</label>
                    <input type="file" 
                           id="subcat_image" 
                           name="subcat_image" 
                           accept=".jpg,.jpeg" 
                           {% if not subcategory %}required{% endif %}
                           onchange="resizeImage(this)">
                    {% if subcategory and subcategory.Subcat_image %}
                        <div class="current-image">
                            <p>Current Image:</p>
                            <img src="data:image/jpeg;base64,{{ subcategory.Subcat_image }}" 
                                 alt="{{ subcategory.Subcat_name }}" 
                                 class="table-image">
                        </div>
                    {% endif %}
                    <input type="hidden" name="resized_image" id="resized_image">
                </div>

                <button type="submit" class="{% if subcategory %}edit-btn{% else %}add-btn{% endif %}">
                    {{ 'Update Subcategory' if subcategory else 'Add Subcategory' }}
                </button>
            </form>
        </div>

        <!-- Subcategories Table --><h2><center>Subcategory Details</center></h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th>                   
                    <th>Subcategory Name</th>
                    <th>Category</th>
                    <th>Description</th>
                    <th>Image</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for subcat in subcategories %}
                    <tr>
                        <td>{{ subcat.Subcat_id }}</td>                        
                        <td>{{ subcat.Subcat_name }}</td>
                        <td>{{ subcat.Cat_name }}</td>
                        <td>{{ subcat.Subcat_desc }}</td>
                        <td><img src="data:image/jpeg;base64,{{ subcat.Subcat_image }}" 
                            alt="{{ subcat.Subcat_name }}" 
                            class="table-image"></td>
                        <td>{{ "Active" if subcat.Subcat_status == 1 else "Inactive" }}</td>
                        <td class="action-buttons">
                        {% if subcat.Subcat_status == 1 %}
                           <!-- Edit action when the subcategory is active -->
                            <a href="{{ url_for('edit_subcategory_route', subcat_id=subcat.Subcat_id) }}" class="edit-link">
                            <button type="button">Edit</button>
                            </a>
        
                            <!-- Deactivate action when the subcategory is active -->
                            <form action="{{ url_for('change_subcategory_status_route', subcat_id=subcat.Subcat_id, status=0) }}" 
                            method="POST" style="display: inline;">
                            <button type="submit" class="deactivate">Deactivate</button>
                            </form>
                        {% else %}
                            <!-- Activate action when the subcategory is inactive -->
                            <form action="{{ url_for('change_subcategory_status_route', subcat_id=subcat.Subcat_id, status=1) }}" 
                            method="POST" style="display: inline;">
                            <button type="submit" class="activate">Activate</button>
                            </form>
                        {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</body>
</html>